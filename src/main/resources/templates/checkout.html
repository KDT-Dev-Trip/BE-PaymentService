<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>토스페이먼츠 결제</title>
    <script src="https://js.tosspayments.com/v1/payment-widget"></script>
    <style>
        body { 
            font-family: 'Pretendard Variable', sans-serif; 
            max-width: 540px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f8f9fa;
        }
        .payment-wrapper {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
        }
        .payment-info { 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 24px;
            border: 1px solid #e5e8eb;
        }
        .payment-info h3 {
            margin: 0 0 16px 0;
            color: #191f28;
            font-size: 18px;
            font-weight: 600;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .info-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            font-size: 16px;
            border-top: 1px solid #e5e8eb;
            padding-top: 12px;
            margin-top: 12px;
        }
        .info-label {
            color: #8b95a1;
            font-size: 14px;
        }
        .info-value {
            color: #191f28;
            font-size: 14px;
        }
        #payment-method {
            margin: 24px 0;
        }
        #agreement {
            margin: 24px 0;
        }
        .payment-button { 
            width: 100%; 
            padding: 16px; 
            background: #3182f6; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .payment-button:hover { 
            background: #1b64da; 
        }
        .payment-button:disabled {
            background: #d0d5dd;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #8b95a1;
        }
    </style>
</head>
<body>
    <div class="payment-wrapper">
        <h1 style="text-align: center; color: #191f28; margin-bottom: 32px;">결제하기</h1>
        
        <div class="payment-info">
            <h3>주문 정보</h3>
            <div class="info-row">
                <span class="info-label">상품명</span>
                <span class="info-value" th:text="${orderName}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">주문번호</span>
                <span class="info-value" th:text="${orderId}"></span>
            </div>
            <div class="info-row">
                <span class="info-label">주문자</span>
                <span class="info-value" th:text="${customerName} + ' (' + ${customerEmail} + ')'"></span>
            </div>
            <div class="info-row">
                <span class="info-label">결제금액</span>
                <span class="info-value" th:text="${#numbers.formatInteger(amount, 0, 'COMMA')} + '원'"></span>
            </div>
        </div>

        <div id="payment-method"></div>
        <div id="agreement"></div>
        
        <div class="loading" id="loading">
            결제 정보를 불러오는 중입니다...
        </div>
        
        <button class="payment-button" onclick="requestPayment()" id="payment-button">
            <span th:text="${#numbers.formatInteger(amount, 0, 'COMMA')} + '원 결제하기'"></span>
        </button>
    </div>

    <script th:inline="javascript">
        const clientKey = [[${clientKey}]];
        const customerKey = "customer_" + Math.random().toString(36).substring(7);
        const amount = [[${amount}]];
        
        let paymentWidget;
        let paymentMethodWidget;
        let isWidgetReady = false;
        
        async function init() {
            try {
                // 로딩 상태 표시
                document.getElementById('loading').style.display = 'block';
                document.getElementById('payment-button').disabled = true;
                
                // PaymentWidget 초기화
                paymentWidget = PaymentWidget(clientKey, customerKey);
                
                // 결제수단 위젯 렌더링 (Promise 반환)
                paymentMethodWidget = paymentWidget.renderPaymentMethods(
                    "#payment-method",
                    { value: amount },
                    { variantKey: "DEFAULT" }
                );
                
                // 약관 위젯 렌더링
                paymentWidget.renderAgreement("#agreement", { variantKey: "AGREEMENT" });
                
                // 위젯이 완전히 렌더링될 때까지 기다림
                await Promise.all([
                    paymentMethodWidget,
                    new Promise(resolve => setTimeout(resolve, 2000)) // 추가 안전 시간
                ]);
                
                // 렌더링 완료 확인
                isWidgetReady = true;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('payment-button').disabled = false;
                
                console.log('결제 위젯 준비 완료');
                
            } catch (error) {
                console.error('위젯 초기화 실패:', error);
                document.getElementById('loading').innerHTML = 
                    '<span style="color: red;">결제 위젯 로딩에 실패했습니다: ' + error.message + '</span>';
                document.getElementById('payment-button').disabled = true;
                isWidgetReady = false;
            }
        }
        
        async function requestPayment() {
            if (!paymentWidget || !isWidgetReady) {
                alert('결제 위젯이 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            try {
                // 버튼 비활성화
                document.getElementById('payment-button').disabled = true;
                document.getElementById('payment-button').innerHTML = '결제 처리 중...';
                
                // 결제 요청
                await paymentWidget.requestPayment({
                    orderId: [[${orderId}]],
                    orderName: [[${orderName}]],
                    customerName: [[${customerName}]],
                    customerEmail: [[${customerEmail}]],
                    successUrl: window.location.origin + "/payment/success",
                    failUrl: window.location.origin + "/payment/fail"
                });
            } catch (error) {
                // 버튼 상태 복원
                document.getElementById('payment-button').disabled = false;
                document.getElementById('payment-button').innerHTML = 
                    [[${#numbers.formatInteger(amount, 0, 'COMMA')}]] + '원 결제하기';
                
                // 사용자가 결제를 취소한 경우
                if (error.code === 'USER_CANCEL') {
                    console.log('사용자가 결제를 취소했습니다.');
                } else {
                    console.error('결제 요청 실패:', error);
                    alert('결제 요청 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }
        
        // 페이지 로드 시 위젯 초기화
        window.addEventListener('load', init);
    </script>
</body>
</html>